section .data

opcodes:
	dq run_method.loop
	dq run_method.loop
	dq opcode_impl.iconst_m1
	dq opcode_impl.iconst_0
	dq opcode_impl.iconst_1
	dq opcode_impl.iconst_2
	dq opcode_impl.iconst_3
	dq opcode_impl.iconst_4
	dq opcode_impl.iconst_5
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq opcode_impl.bipush
	dq opcode_impl.sipush
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq opcode_impl.iload_0
	dq opcode_impl.iload_1
	dq opcode_impl.iload_2
	dq opcode_impl.iload_3
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq opcode_impl.aload_1
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq opcode_impl.istore_0
	dq opcode_impl.istore_1
	dq opcode_impl.istore_2
	dq opcode_impl.istore_3
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq opcode_impl.iadd
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq opcode_impl.ireturn
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq opcode_impl.return
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.loop
	dq run_method.end

section .text
	global run_method

run_method:
	push rbp
	mov rbp, rsp

	;; store bytecode pointer
	mov r10, rdx

	;; reserve space for local variables (4 bytes per slot)
	mov rax, 8h
	mul rsi
	sub rsp, rax
	;; and save a pointer to the first local variable
	mov r11, rsp

.loop:	xor rax, rax
	mov al, [r10]
	add r10, 1h
	jmp [rax*8+opcodes]

.end:	mov rsp, rbp
	pop rbp
	ret

opcode_impl:

.iconst_m1:
	mov rax, -1h
	push rax
	jmp run_method.loop
.iconst_0:
	mov rax, 0h
	push rax
	jmp run_method.loop
.iconst_1:
	mov rax, 1h
	push rax
	jmp run_method.loop
.iconst_2:
	mov rax, 2h
	push rax
	jmp run_method.loop
.iconst_3:
	mov rax, 3h
	push rax
	jmp run_method.loop
.iconst_4:
	mov rax, 4h
	push rax
	jmp run_method.loop
.iconst_5:
	mov rax, 5h
	push rax
	jmp run_method.loop
	
.bipush:
	mov al, [r10]
	movsx rax, al
	push rax
	add r10, 1h
	jmp run_method.loop
.sipush:
	mov ax, [r10]
	xchg al, ah
	movsx rax, ax
	push rax
	add r10, 2h
	jmp run_method.loop

.iload_0:
	mov eax, [r11]
	push rax
	jmp run_method.loop
.iload_1:
	mov eax, [r11+8h]
	push rax
	jmp run_method.loop
.iload_2:
	mov eax, [r11+10h]
	push rax
	jmp run_method.loop
.iload_3:
	mov eax, [r11+18h]
	push rax
	jmp run_method.loop

.istore_0:
	pop rax
	mov [r11], eax
	jmp run_method.loop
.istore_1:
	pop rax
	mov [r11+8h], eax
	jmp run_method.loop
.istore_2:
	pop rax
	mov [r11+10h], eax
	jmp run_method.loop
.istore_3:
	pop rax
	mov [r11+18h], eax
	jmp run_method.loop

.aload_1:
	mov eax, [r11]
	push rax
	jmp run_method.loop

.iadd:
	pop rax
	pop rbx
	add eax, ebx
	push rax
	jmp run_method.loop

.return:
	xor rax,rax
	jmp run_method.end
.ireturn:
	pop rax
	jmp run_method.end
	